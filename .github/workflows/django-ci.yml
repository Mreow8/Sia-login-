name: Django CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the code
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11 # Use the version you need

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-decouple firebase-admin sib-api-v3-sdk

      # 4. Create Firebase folder
      - name: Create Firebase folder
        run: mkdir -p firebase

      # 5. Write Firebase service account JSON from secret
      - name: Write Firebase credentials
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase/serviceAccountKey.json
          cat firebase/serviceAccountKey.json | head -n 5  # Optional debug to check first few lines

      # 6. Write .env file dynamically
      - name: Write .env
        run: |
          echo "DEBUG=True" > .env
          echo "SECRET_KEY=replace-this-with-a-secret" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,yourapp.onrender.com" >> .env
          echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> .env
          echo "FIREBASE_AUTH_DOMAIN=your-firebase-auth-domain" >> .env
          echo "FIREBASE_PROJECT_ID=your-firebase-project-id" >> .env
          echo "FIREBASE_STORAGE_BUCKET=your-firebase-storage-bucket" >> .env
          echo "FIREBASE_MESSAGING_SENDER_ID=your-firebase-sender-id" >> .env
          echo "FIREBASE_APP_ID=your-firebase-app-id" >> .env
          echo "FIREBASE_MEASUREMENT_ID=your-firebase-measurement-id" >> .env
          echo "FIREBASE_SERVICE_ACCOUNT=firebase/serviceAccountKey.json" >> .env
          echo "BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}" >> .env
          echo "BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}" >> .env
          echo "BREVO_SENDER_NAME=${{ secrets.BREVO_SENDER_NAME }}" >> .env

      # 7. Run Django migrations
      - name: Django migrations
        run: |
          python manage.py migrate

      # 8. Collect static files (if needed)
      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput

      # 9. Run tests
      - name: Run Django tests
        run: |
          python manage.py test

      # 10. Optional: Deploy steps here (e.g., Render, Heroku)
      # - name: Deploy to Render
      #   run: render deploy --service your-service-id
