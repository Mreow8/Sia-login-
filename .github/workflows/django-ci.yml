name: Django CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      # You can define some defaults here if needed
      DEBUG: "True"
      SECRET_KEY: "replace-with-a-secure-key"
      ALLOWED_HOSTS: "localhost,127.0.0.1,yourapp.onrender.com"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-decouple firebase-admin sib-api-v3-sdk

      # --- Create .env from GitHub Secrets ---
      - name: Create .env file
        run: |
          mkdir -p firebase
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase/serviceAccountKey.json
          echo "DEBUG=True" > .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,yourapp.onrender.com" >> .env
          echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> .env
          echo "FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}" >> .env
          echo "FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}" >> .env
          echo "FIREBASE_SERVICE_ACCOUNT=firebase/serviceAccountKey.json" >> .env
          echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> .env
          echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> .env
          echo "BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}" >> .env
          echo "BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}" >> .env
          echo "BREVO_SENDER_NAME=${{ secrets.BREVO_SENDER_NAME }}" >> .env

      - name: Apply migrations
        run: |
          python manage.py migrate

      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput

      - name: Run tests
        run: |
          python manage.py test

      # Optional: Deployment step to Render, Heroku, or other host
      # - name: Deploy to Render
      #   run: |
      #     curl -X POST -H "Accept: application/json" \
      #     -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
      #     https://api.render.com/deploy/srv-xxxxxx
